<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Newton approximation</title>
    <script src="modernizr.js"></script>
    <script type="text/javascript">
        window.addEventListener("load", eventWindowLoaded, false);

        function eventWindowLoaded() {
            canvasApp();
        }

        function canvasSupport() {
            return Modernizr.canvas;
        }

        function canvasApp() {
            if (!canvasSupport()) {
                return;
            }

            var theCanvas = document.getElementById("canvasOne");
            var context = theCanvas.getContext("2d");

            /*
            function drawBase(size) {
                context.strokeStyle = "#FFFFFF";

                context.beginPath();
                context.moveTo(0 + 0.5, size + 0.5);
                context.lineTo(size / 2 + 0.5, 0.5);
                context.stroke();

                context.beginPath();
                context.moveTo(0 - 0.5, size - 0.5);
                context.lineTo(size - 0.5, size - 0.5);
                context.stroke();

                context.beginPath();
                context.moveTo(size / 2 + 0.5, 0.5);
                context.lineTo(size - 0.5, size - 0.5);
                context.stroke();

                return [{x: 0, y: 0, size: size}];
            }

            function drawRecursive(x, y, size) {
                context.strokeStyle = "#FFFFFF";

                context.beginPath();
                context.moveTo(x + size/2 + 0.5, y + size + 0.5);
                context.lineTo(x + size/4 + 0.5, y + size/2 + 0.5);
                context.stroke();

                context.beginPath();
                context.moveTo(x + size/2 + 0.5, y + size + 0.5);
                context.lineTo(x + 3*size/4 + 0.5, y + size/2 + 0.5);
                context.stroke();

                context.beginPath();
                context.moveTo(x + size/4 + 0.5, y + size/2 + 0.5);
                context.lineTo(x + 3*size/4 + 0.5, y + size/2 + 0.5);
                context.stroke();

                if (size < 50) {
                    return [];
                }
                return [
                    {x: x + size / 4, y: y, size: size / 2},
                    {x: x, y: y + size / 2, size: size / 2},
                    {x: x + size / 2, y: y + size / 2, size: size / 2},
                ];
            }
            */

            function drawBase(size) {
                context.strokeStyle = "#FFFFFF";
                context.lineWidth = 1;

                context.beginPath();
                context.arc(size / 2, size / 2, size / 2, 0, 2*Math.PI, false);
                context.stroke();

                return [{x: 0, y: 0, size: size}];
            }

            function drawRecursive(x, y, size) {
                context.strokeStyle = "#FFFFFF";
                context.lineWidth = 1;

                // http://en.wikipedia.org/wiki/Circle_packing_in_a_circle
                var radius = size / 2 / (1 + 2/3 * Math.sqrt(3));

                var center1_x = x + (size - 2*radius) / 2 + radius;
                var center1_y = y + radius;

                context.beginPath();
                context.arc(center1_x, center1_y, radius, 0, 2*Math.PI, false);
                context.stroke();

                var center2_x = center1_x + 2*radius*Math.sin(Math.PI/6);
                var center2_y = center1_y + 2*radius*Math.cos(Math.PI/6);

                context.beginPath();
                context.arc(center2_x, center2_y, radius, 0, 2*Math.PI, false);
                context.stroke();

                var center3_x = center1_x - 2*radius*Math.sin(Math.PI/6);
                var center3_y = center2_y;


                context.beginPath();
                context.arc(center3_x, center3_y, radius, 0, 2*Math.PI, false);
                context.stroke();

                if (size < 15) {
                    return [];
                }
                return [
                    {x: center1_x - radius, y: center1_y - radius, size: 2*radius},
                    {x: center2_x - radius, y: center2_y - radius, size: 2*radius},
                    {x: center3_x - radius, y: center3_y - radius, size: 2*radius},
                ];
            }

            function drawScreen() {
                // We're in space so make the whole canvas black.
                context.fillStyle = "#000000";
                context.fillRect(0, 0, theCanvas.width, theCanvas.height);

                squares = drawBase(theCanvas.width);

                while (squares.length > 0) {
                    nextsquares = [];
                    for (var i = 0; i < squares.length; i++) {
                        if (squares[i].size >= 1) {
                            nextsquares = nextsquares.concat(
                                drawRecursive(squares[i].x, squares[i].y, squares[i].size)
                            );
                        }
                    }
                    squares = nextsquares;
                }

                genImage();

            }


            function genImage() {
                var img = theCanvas.toDataURL("image/png");
                document.getElementById("theThing").src = img;
            }


            function gameLoop() {
                // setTimeout(gameLoop, 20);
                drawScreen();
            }

            gameLoop();
        }

    </script>
</head>
<body style="background-color: black;">
    <canvas id="canvasOne" width="1024" height="1024">
        Your browser does not support HTML5 canvas.
    </canvas>
<img id="theThing" src="https://defuse.ca/images/ossbox_header_background.png" />
</body>
